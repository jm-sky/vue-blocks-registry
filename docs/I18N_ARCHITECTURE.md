# i18n Architecture

This document explains how internationalization (i18n) works in vue-blocks-registry and how it's structured in user projects.

## Overview

The i18n system is split into two layers:
1. **Registry layer** (`src/shared/i18n/`) - Base i18n configuration and common translations
2. **Application layer** (`src/i18n/`) - Aggregates registry + module translations

## Directory Structure

### In Registry (vue-blocks-registry)

```
registry/shared/i18n/
├── config/
│   └── i18n.ts              # Core i18n configuration with createI18nInstance()
├── locales/
│   ├── en.ts                # Common English translations (validation, errors, etc.)
│   └── pl.ts                # Common Polish translations
├── composables/
│   └── useLocale.ts         # Locale switching composable
├── components/
│   ├── LocaleToggle.vue     # Language toggle button
│   ├── LocaleSwitcher.vue   # Language switcher
│   └── LocaleDropdown.vue   # Language dropdown
└── index.ts                 # Public exports
```

### In User Project

```
src/
├── shared/i18n/             # Installed from registry (i18n-config bundle)
│   ├── config/i18n.ts       # Core i18n logic
│   ├── locales/
│   │   ├── en.ts
│   │   └── pl.ts
│   ├── composables/useLocale.ts
│   └── index.ts
│
├── i18n/                    # Application-level aggregator (generated by scaffold)
│   └── index.ts             # Merges registry + module messages
│
└── modules/
    ├── auth/i18n/           # Auth module translations
    │   ├── index.ts
    │   └── locales/
    │       ├── en.ts
    │       └── pl.ts
    ├── user/i18n/           # User module translations
    │   └── ...
    └── settings/i18n/       # Settings module translations
        └── ...
```

## How It Works

### 1. Registry Provides Base Configuration

`shared/i18n/config/i18n.ts` exports:
- `createI18nInstance(options)` - Factory function to create i18n instance
- `defaultI18nOptions` - Default configuration
- `i18n` - Default instance (for standalone use)
- `SUPPORTED_LOCALES` - Array of supported locales
- `LOCALE_LABELS` - Human-readable locale names

**Key feature:** All locale detection logic (localStorage, browser language, fallback) is handled here.

### 2. Application Aggregates All Translations

`src/i18n/index.ts` (generated by `scaffold` command):
- Imports `createI18nInstance()` from `@/shared/i18n`
- Imports base translations from `@/shared/i18n/locales/*`
- Imports module-specific translations (auto-injected by CLI)
- Merges all translations together
- Creates final i18n instance with merged messages

**Example:**
```typescript
import { createI18nInstance } from '@/shared/i18n'
import registryEn from '@/shared/i18n/locales/en'
import registryPl from '@/shared/i18n/locales/pl'
import { authEn, authPl } from '@/modules/auth/i18n'
import { userEn, userPl } from '@/modules/user/i18n'

const en = { ...registryEn, ...authEn, ...userEn }
const pl = { ...registryPl, ...authPl, ...userPl }

export const i18n = createI18nInstance({ messages: { en, pl } })
```

### 3. Module-Specific Translations

Each module (auth, user, settings, logs) has its own i18n folder:

```typescript
// modules/auth/i18n/index.ts
export { default as authEn } from './locales/en'
export { default as authPl } from './locales/pl'

// modules/auth/i18n/locales/en.ts
export default {
  auth: {
    login: {
      title: 'Sign In',
      // ...
    }
  }
}
```

### 4. CLI Auto-Injection

When you install a module bundle (e.g., `authFull`, `userFull`), the CLI automatically:
1. Detects module has i18n files
2. Injects imports into `src/i18n/index.ts`:
   ```typescript
   // @vbr-insert-module-imports
   import { authEn } from '@/modules/auth/i18n'
   import { authPl } from '@/modules/auth/i18n'
   ```
3. Updates merge statements:
   ```typescript
   // @vbr-insert-module-merges
   const en = { ...registryEn, ...authEn }
   const pl = { ...registryPl, ...authPl }
   ```

**Injection markers:**
- `// @vbr-insert-module-imports` - Where module imports are injected
- `// @vbr-insert-module-merges` - Where merge statements are updated

## Registry Items

### i18n-config (registry:lib)
Base i18n configuration with locale detection logic.

**Files:**
- `shared/i18n/config/i18n.ts` → `src/shared/i18n/config/i18n.ts`
- `shared/i18n/locales/en.ts` → `src/shared/i18n/locales/en.ts`
- `shared/i18n/locales/pl.ts` → `src/shared/i18n/locales/pl.ts`
- `shared/i18n/index.ts` → `src/shared/i18n/index.ts`

**Dependencies:** `vue-i18n`, `config`

### i18n-composables (registry:lib)
Vue composable for locale management.

**Files:**
- `shared/i18n/composables/useLocale.ts` → `src/shared/i18n/composables/useLocale.ts`

**Dependencies:** `vue-i18n`, `i18n-config`

### locale-toggle / locale-switcher / locale-dropdown (registry:ui)
UI components for language switching.

**Dependencies:** `button`, `dropdown-menu`, `i18n-composables`

### i18n (registry:feature)
Complete i18n bundle - installs all of the above.

## Important Rules

### ✅ DO:
- Use `createI18nInstance()` from `@/shared/i18n` in your application
- Let CLI manage `src/i18n/index.ts` injection markers
- Keep module translations in `modules/{module}/i18n/`
- Use `@registry/*` imports in registry files

### ❌ DON'T:
- Duplicate i18n configuration logic in application layer
- Manually edit injection markers in `src/i18n/index.ts`
- Mix registry translations with module translations
- Use `@/` imports in registry files

## Usage in Components

```vue
<script setup lang="ts">
import { useI18n } from 'vue-i18n'

const { t, locale } = useI18n()
</script>

<template>
  <h1>{{ t('auth.login.title') }}</h1>
  <p>{{ t('common.validation.required') }}</p>
</template>
```

## Adding Custom Translations

If you want to add app-specific translations (not from modules):

1. Create `src/i18n/locales/en.ts` and `src/i18n/locales/pl.ts`
2. Import them in `src/i18n/index.ts`:
   ```typescript
   import appEn from './locales/en'
   import appPl from './locales/pl'

   const en = { ...registryEn, ...authEn, ...appEn }
   const pl = { ...registryPl, ...authPl, ...appPl }
   ```

## Troubleshooting

### Issue: Missing translations after installing module

**Solution:** Check if CLI properly injected imports in `src/i18n/index.ts`. Look for:
- Import statements below `// @vbr-insert-module-imports`
- Spread operators in merge statements

### Issue: Type errors with i18n instance

**Solution:** Ensure you're importing from correct location:
- `import { i18n } from '@/i18n'` - Application instance (merged)
- `import { i18n } from '@/shared/i18n'` - Registry base instance (minimal)

Use the application instance in `main.ts`.

### Issue: Locale not persisting

**Solution:** Check `LOCALE_STORAGE_KEY` in `@/shared/config/config.ts` is unique per app.

## CLI Commands Reference

- `scaffold --all` - Generates `src/i18n/index.ts` with injection markers
- `add i18n` - Installs complete i18n feature bundle
- `add authFull` - Installs auth module + auto-injects i18n imports
- `setup --all` - Complete setup including i18n configuration

## Architecture Benefits

1. **No Code Duplication** - i18n logic is in one place (`shared/i18n/config/i18n.ts`)
2. **Automatic Merging** - CLI handles injection of module translations
3. **Type Safety** - TypeScript types flow from merged messages
4. **Scalable** - Easy to add new modules with their own translations
5. **Maintainable** - Clear separation between registry, modules, and app translations
